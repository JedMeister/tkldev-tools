#!/bin/bash -e

fatal() { echo "FATAL: $@" >&2 ; exit 1 ; }

ORIGIN=${ORIGIN:-JedMeister}
TKL=${TKL:-turnkey}
PROT=${PROT:-ssh}

[[ -n "$FAB_PATH" ]] || fatal "FAB_PATH not set"

usage() {
    cat <<EOF
Script to clone TurnKey appliance repos from GitHub and add your own remote
(GittHub remote fork must exist). Optionally add additional remotes.

$(basename $0) APP_NAME [REPO1[ REPO2, ...]] [-d|--dir DIR]

Note: requires GitHub credentials already configured.

Args::

    APP_NAME    Appliance repo to clone.
                - will fail if not given or app doesn't exist.

Options::

    REPO        Space separated of GitHub user names and/or TKL team members.
                Only a few TKL team members are supported by default. If other
                repos are included, must be GitHub user namerepo remote to add (optional).
                Requires GH
                Currently only supports a few, see code of this script to see
                who.

    -d|--dir    Directory to clone into.
                - default $FAB_PATH/products

Env vars::

    ORIGIN      Remote name of 'origin' - currently: $ORIGIN
    TKL         Name of TurnKey repo - can be set to \$ORIGIN

TODO:
    - Provide separate config file - inc exisitng env vars. Set defaults there
    - Support additional custom remotes (via config &/or switch &/or env
      var)
    - Document and/or display default TKL_team_repos
    - Allow local alias for users, inc valid TKL_team_repos - currently
      requires GitHub username

EOF
}

conf() {
    case $1 in
        origin)
            echo "git@github.com:JedMeister";;
        ongle)
            echo "https://github.com/OnGle";;
        qq7)
            echo "https://github.com/qq7";;
        *)
            fatal "Unknown remote: ${1}";;
    esac
}

add_remote() {
    app=${1}
    name=${2}
    remote=$(conf ${name})/${app}.git
    git remote add $name $remote
    git fetch $name
}

while [[ $# -gt 0 ]]; then


app=${1} && shift || fatal "Needs at least one arg"

git clone git@github.com:turnkeylinux-apps/${app}.git -o turnkey
cd ${app}
add_remote ${app} origin

while [[ "$#" -gt 0 ]]; do
    case $1 in
        --)
            shift;;
        *)
            add_remote ${app} ${1}
            shift;;
    esac
done
git push origin master
