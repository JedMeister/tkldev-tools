#!/bin/bash -eu

info() { echo "INFO: $@"; }
fatal() { echo "FATAL: $@" >&2; exit 1; }

usage() {
    exit_code=$1
    shift
    [[ $# -eq 0 ]] || echo "FATAL: $@"
    cat <<EOF
$(basename $0) TARGET

    Rewind build to TARGET layer.

    Select the latest target you want to still exist.

    Valid targets:
        root.patched
        root.build
        bootstrap

EOF
    exit $exit_code
}

[[ -z "$DEBUG" ]] || set -x

target=$1
[[ -n "$target" ]] || usage 1 "Target must be set."

stop_services() {
    targ=$1
    info "Stopping services"
    for service in mysql pgsql apache2 lighttpd nginx; do
        fab-chroot build/$targ service $service stop 2>/dev/null || true
    done
}

undeck() {
    targ=$1
    if [[ -d build/$targ ]]; then
        stop_services $targ
        if [[ "$targ" == "cdroot" ]]; then
            rm -rf build/product.iso
            rm -rf build/$targ
        else
            deck -D build/$targ
        fi
    fi
    rm -f build/stamps/$targ
}

case $target in
    root.patched)
        undeck cdroot
        undeck root.sandbox
        ;;
    root.build)
        undeck cdroot
        undeck root.sandbox
        undeck root.patched
        ;;
    bootstrap)
        undeck cdroot;
        undeck root.sandbox
        undeck root.patched
        undeck root.build
        ;;
    help)
        usage 0
        ;;
    *)
        usage 1 "Unknown target: $target."
esac
